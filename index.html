<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perímetro e Corte</title>
    <!-- Adicionando Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-image: url('https://source.unsplash.com/1920x1080/?nature');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 0.9; /* Opacidade da imagem de fundo */
        }
        .container {
            background-color: rgba(255, 255, 255, 0.7); /* Fundo transparente */
            padding: 20px;
            border-radius: 10px;
        }
        .perimetro-input, .corte-input {
            border: 1px solid black;
        }
        .linha-tabela {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Bem-vindo, <span id="nomeDigitado"></span>!</h1>
        <script>
            // Verifica se o nome já foi digitado anteriormente
            let nome = localStorage.getItem('nome');
            if (!nome) {
                // Se não houver nome salvo, solicita o nome ao usuário
                nome = prompt("Qual é o seu nome?");
                // Salva o nome no armazenamento local
                localStorage.setItem('nome', nome);
            }
            // Exibe o nome na tela
            document.getElementById('nomeDigitado').innerText = nome;
        </script>
        <form id="form" class="mt-3">
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="perimetro">Histórico:</label>
                    <input type="number" class="form-control perimetro-input" id="perimetro" required maxlength="3">
                </div>
                <div class="form-group col-md-3">
                    <label for="corte">Corte:</label>
                    <input type="text" class="form-control corte-input" id="corte" required>
                </div>
                <div class="form-group col-md-4">
                    <label for="observacao">Observação:</label>
                    <input type="text" class="form-control" id="observacao">
                </div>
                <div class="form-group col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary btn-block" id="salvar">Salvar</button>
                </div>
            </div>
        </form>
        <div class="mt-5">
            <label for="buscarPerimetro">Buscar por Histórico:</label>
            <input type="number" class="form-control" id="buscarPerimetro" placeholder="Digite o histórico">
        </div>
        <div id="tabelaDados" class="mt-3">
            <!-- A tabela dos dados salvos será exibida aqui -->
        </div>
        <div id="tabelaHistoricos" class="mt-5">
            <!-- A tabela com os históricos adicionados até o momento será exibida aqui -->
        </div>
    </div>

    <!-- Adicionando Bootstrap JS (opcional, apenas se necessário) -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // JavaScript
        const form = document.getElementById('form');
        const salvarButton = document.getElementById('salvar');
        const buscarPerimetroInput = document.getElementById('buscarPerimetro');
        const tabelaDados = document.getElementById('tabelaDados');
        const tabelaHistoricos = document.getElementById('tabelaHistoricos');

        // Carregar dados salvos localmente
        let dadosSalvos = JSON.parse(localStorage.getItem('dados')) || [];
        const historicosSalvos = new Set(dadosSalvos.map(dado => dado.perimetro));

        // Preencher a tabela de dados e a tabela de históricos
        renderizarTabelaDados();
        renderizarTabelaHistoricos();

        salvarButton.addEventListener('click', function() {
            const perimetro = document.getElementById('perimetro').value;
            if (perimetro.length > 3) {
                alert("Coloque somente três números no histórico.");
                return;
            }
            const corte = document.getElementById('corte').value;
            if (!validarCorte(corte)) {
                alert("Coloque novamente o corte. Este corte está errado.");
                return;
            }
            const observacao = document.getElementById('observacao').value;
            const data = new Date().toLocaleString();

            // Salvar os dados localmente
            dadosSalvos.push({ perimetro, corte, observacao, data });
            localStorage.setItem('dados', JSON.stringify(dadosSalvos));
            historicosSalvos.add(perimetro);

            renderizarTabelaDados();
            renderizarTabelaHistoricos();
            form.reset();
        });

        function validarCorte(corte) {
            const corteValue = parseFloat(corte.replace(',', '.'));
            return !isNaN(corteValue) && corteValue <= 200;
        }

        function renderizarTabelaDados() {
            tabelaDados.innerHTML = '';
            const perimetroBuscado = buscarPerimetroInput.value;
            const dadosFiltrados = dadosSalvos.filter(dado => dado.perimetro == perimetroBuscado);

            if (dadosFiltrados.length > 0) {
                const table = document.createElement('table');
                table.classList.add('table', 'table-striped', 'mt-3');
                const header = document.createElement('thead');
                header.innerHTML = `
                    <tr>
                        <th>Histórico</th>
                        <th>Corte</th>
                        <th>Observação</th>
                        <th>Data</th>
                        <th></th>
                    </tr>
                `;
                const body = document.createElement('tbody');
                dadosFiltrados.forEach((dado, index) => {
                    const row = document.createElement('tr');
                    row.classList.add('linha-tabela');
                    row.innerHTML = `
                        <td>${dado.perimetro}</td>
                        <td>${dado.corte}</td>
                        <td>${dado.observacao}</td>
                        <td>${dado.data}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="confirmarExclusao(${dadosSalvos.indexOf(dado)})">Remover</button></td>
                    `;
                    body.appendChild(row);
                });
                table.appendChild(header);
                table.appendChild(body);
                tabelaDados.appendChild(table);
            } else {
                tabelaDados.innerHTML = '<p>Nenhum dado encontrado para o histórico especificado.</p>';
            }
        }

        function confirmarExclusao(index) {
            if (confirm("Tem certeza de que deseja excluir este dado?")) {
                removerEntrada(index);
            }
        }

        function removerEntrada(index) {
            const perimetroRemovido = dadosSalvos[index].perimetro;
            dadosSalvos.splice(index, 1);
            localStorage.setItem('dados', JSON.stringify(dadosSalvos));
            renderizarTabelaDados();
            
            // Verificar se o histórico removido não possui mais dados associados
            if (!dadosSalvos.some(dado => dado.perimetro === perimetroRemovido)) {
                historicosSalvos.delete(perimetroRemovido);
                renderizarTabelaHistoricos();
            }
        }

        function renderizarTabelaHistoricos() {
            tabelaHistoricos.innerHTML = '';
            const historicosOrdenados = Array.from(historicosSalvos).sort((a, b) => a - b);

            if (historicosOrdenados.length > 0) {
                const table = document.createElement('table');
                table.classList.add('table', 'table-striped', 'mt-3');
                const header = document.createElement('thead');
                header.innerHTML = `
                    <tr>
                        <th>Histórico</th>
                    </tr>
                `;
                const body = document.createElement('tbody');
                historicosOrdenados.forEach(historico => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${historico}</td>
                    `;
                    body.appendChild(row);
                });
                table.appendChild(header);
                table.appendChild(body);
                tabelaHistoricos.appendChild(table);
            } else {
                tabelaHistoricos.innerHTML = '<p>Nenhum histórico adicionado até o momento.</p>';
            }
        }

        buscarPerimetroInput.addEventListener('input', renderizarTabelaDados);
    </script>
</body>
</html>
